
name: Node Js ElasticBeansTalk

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    
// Create jobs to create your image which you can deploy on AWS, I am running my Node12 application on ubuntu OS. 

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [10.x]

    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

      
// Creating my deployment package and compressing it into a zip file   
// 배포 패키지 만들기 및 zip 파일로 압축
    - name: Generate deployment package
      run: zip -r deploy.zip * -x "**node_modules**"

    - name: Get timestamp
      uses: gerred/actions/current-time@master
      id: current-time

    - name: Run string replace
      uses: frabert/replace-string-action@master
      id: format-time
      with:
        pattern: '[:\.]+'
        string: "${{ steps.current-time.outputs.time }}"
        replace-with: '-'
        flags: 'g'

// Now, its time to deploy our package to Beanstalk that we've configured earlier, to deploy our app we need Secret keys that we can get from the AWS user, every user has separate keys on AWS. 
// 제 이전에 구성한 Beanstalk에 패키지를 배포 할 시간입니다. 앱을 배포하려면 AWS 사용자로부터 얻을 수있는 비밀 키가 필요합니다. 모든 사용자는 AWS에서 별도의 키를 가지고 있습니다.
    - name: Beanstalk Deploy for app
      uses: einaregilsson/beanstalk-deploy@v10
      with:
        aws_access_key: ${{secrets.AWS_ACCESS_REACT_KEY_ID}}
        aws_secret_key: ${{secrets.AWS_SECRET_ACCESS_REACT_KEY}}
        application_name: "elasticBeanStalk-test-express"
        environment_name: "gitrepo-test"
        region: "ap-northeast-2"
        version_label: "elasticBeanStalk-${{ steps.format-time.outputs.replaced }}"
        deployment_package: deploy.zip

    - name: Deployed!
      run: echo App deployed to ELB
